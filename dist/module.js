define(["moment","lodash","app/core/utils/datemath","app/core/table_model","app/plugins/sdk"],function(t,e,n,r,i){return function(t){var e={};function n(r){if(e[r])return e[r].exports;var i=e[r]={i:r,l:!1,exports:{}};return t[r].call(i.exports,i,i.exports,n),i.l=!0,i.exports}return n.m=t,n.c=e,n.d=function(t,e,r){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:r})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)n.d(r,i,function(e){return t[e]}.bind(null,i));return r},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="/",n(n.s=6)}([function(e,n){e.exports=t},function(t,n){t.exports=e},function(t,e){t.exports=n},function(t,e){t.exports=r},function(t,e,n){var r,i,a;
/*!
  * $script.js JS loader & dependency manager
  * https://github.com/ded/script.js
  * (c) Dustin Diaz 2014 | License MIT
  */
/*!
  * $script.js JS loader & dependency manager
  * https://github.com/ded/script.js
  * (c) Dustin Diaz 2014 | License MIT
  */
a=function(){var t,e,n=document,r=n.getElementsByTagName("head")[0],i=!1,a="push",o="readyState",s="onreadystatechange",u={},c={},f={},d={};function l(t,e){for(var n=0,r=t.length;n<r;++n)if(!e(t[n]))return i;return 1}function p(t,e){l(t,function(t){return e(t),1})}function m(e,n,r){e=e[a]?e:[e];var i=n&&n.call,o=i?n:r,s=i?e.join(""):n,g=e.length;function v(t){return t.call?t():u[t]}function y(){if(!--g)for(var t in u[s]=1,o&&o(),f)l(t.split("|"),v)&&!p(f[t],v)&&(f[t]=[])}return setTimeout(function(){p(e,function e(n,r){return null===n?y():(r||/^https?:\/\//.test(n)||!t||(n=-1===n.indexOf(".js")?t+n+".js":t+n),d[n]?(s&&(c[s]=1),2==d[n]?y():setTimeout(function(){e(n,!0)},0)):(d[n]=1,s&&(c[s]=1),void h(n,y)))})},0),m}function h(t,i){var a,u=n.createElement("script");u.onload=u.onerror=u[s]=function(){u[o]&&!/^c|loade/.test(u[o])||a||(u.onload=u[s]=null,a=1,d[t]=2,i())},u.async=1,u.src=e?t+(-1===t.indexOf("?")?"?":"&")+e:t,r.insertBefore(u,r.lastChild)}return m.get=h,m.order=function(t,e,n){!function r(i){i=t.shift(),t.length?m(i,r):m(i,e,n)}()},m.path=function(e){t=e},m.urlArgs=function(t){e=t},m.ready=function(t,e,n){t=t[a]?t:[t];var r,i=[];return!p(t,function(t){u[t]||i[a](t)})&&l(t,function(t){return u[t]})?e():(r=t.join("|"),f[r]=f[r]||[],f[r][a](e),n&&n(i)),m},m.done=function(t){m([null],t)},m},t.exports?t.exports=a():void 0===(i="function"==typeof(r=a)?r.call(e,n,e,t):r)||(t.exports=i)},function(t,e){t.exports=i},function(t,e,n){"use strict";n.r(e);var r,i=n(1),a=n.n(i),o=n(0),s=n.n(o),u=n(2),c=n(3),f=n.n(c),d=n(4),l=n.n(d),p=function(){function t(t,e,n,r,i){this.type=t.type,this.name=t.name,this.id=t.id,this.access=t.jsonData.access||"direct",this.clientId=t.jsonData.clientId,this.scopes="https://www.googleapis.com/auth/calendar.readonly",this.discoveryDocs=["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"],this.q=e,this.templateSrv=n,this.timeSrv=r,this.backendSrv=i,this.initialized=!1}return t.$inject=["instanceSettings","$q","templateSrv","timeSrv","backendSrv"],t.prototype.load=function(){var t=this.q.defer();return l()("https://apis.google.com/js/api.js",function(){gapi.load("client:auth2",function(){return t.resolve()})}),t.promise},t.prototype.testDatasource=function(){return this.initialize().then(function(){return{status:"success",message:"Data source is working",title:"Success"}}).catch(function(t){return console.log(t),{status:"error",message:t.message,title:"Error"}})},t.prototype.initialize=function(){var t=this;return"proxy"===this.access?Promise.resolve([]):this.initialized?Promise.resolve(gapi.auth2.getAuthInstance().currentUser.get()):this.load().then(function(){return gapi.client.init({clientId:t.clientId,scope:t.scopes,discoveryDocs:t.discoveryDocs}).then(function(){var e=gapi.auth2.getAuthInstance();if(!e)throw{message:"failed to initialize"};return e.isSignedIn.get()?(t.initialized=!0,e.currentUser.get()):e.signIn().then(function(e){return t.initialized=!0,e})},function(t){throw console.log(t),{message:"failed to initialize"}})})},t.prototype.query=function(t){var e=this;return this.initialize().then(function(){return Promise.all(t.targets.filter(function(t){return!t.hide}).map(function(n){var r={calendarId:n.calendarId,timeMin:t.range.from.toISOString(),timeMax:t.range.to.toISOString(),orderBy:"startTime",showDeleted:!1,singleEvents:!0,maxResults:250};return e.getEvents(r).then(function(t){return t.sort(function(t,e){return s()(t.start.dateTime||t.start.date)>s()(e.start.dateTime||e.start.date)})})})).then(function(t){var e=new f.a;return e.columns=["startTime","endTime","summary","displayName","description"].map(function(t){return{text:t}}),a.a.each(t,function(t){a.a.each(t,function(t){var n=[s()(t.start.dateTime||t.start.date).valueOf(),s()(t.end.dateTime||t.end.date).valueOf(),t.summary,t.organizer.displayName,t.description||""];e.rows.push(n)})}),{data:[e]}})})},t.prototype.metricFindQuery=function(t){var e=this;return this.initialize().then(function(){var n=e.timeSrv.timeRange(),r=t.match(/^events\((([^,]+), *)?([^,]+), *([^,]+)\)/);if(r){var i=r[2],o=r[3],c=r[4],f={calendarId:i,timeMin:n.from.toISOString(),timeMax:n.to.toISOString(),orderBy:"startTime",q:c,showDeleted:!1,singleEvents:!0,maxResults:250};return e.getEvents(f).then(function(t){return e.q.when(t.map(function(t){return{text:a.a.get(t,o)}}))})}var d=t.match(/^(start|end)\((([^,]+), *)?([^,]+), *([^,]+), *([^,]+)\)/);if(d){var l="start"===d[1]?"start":"end",p=(i=d[3],d[4]),m=parseInt(d[5],10);c=d[6],f={calendarId:i,timeMin:n.from.toISOString(),timeMax:n.to.toISOString(),orderBy:"startTime",q:c,showDeleted:!1,singleEvents:!0,maxResults:250};return e.getEvents(f).then(function(t){t.sort(function(t,e){return s()(t.start.dateTime||t.start.date)>s()(e.start.dateTime||e.start.date)});var e=0-m;if(e<0||e>=t.length)return{};var r=s()(t[e][l].dateTime||t[e][l].date);return"offset"===p||"-offset"===p?(r=Math.floor(s.a.duration(n.to.diff(r)).asSeconds()),"offset"===p&&(r=-r),r+="s"):r=r.format(p),[{text:r}]})}var h=t.match(/^range\((([^,]+), *)?([^,]+), *([^,]+), *([^,]+)\)/);if(h){i=h[2];var g=h[3],v=parseInt(h[4],10);c=h[5],f={calendarId:i,timeMin:n.from.toISOString(),timeMax:n.to.toISOString(),orderBy:"startTime",q:c,showDeleted:!1,singleEvents:!0,maxResults:250};return e.getEvents(f).then(function(t){t.sort(function(t,e){return s()(t.start.dateTime||t.start.date)>s()(e.start.dateTime||e.start.date)});var e=0-v;if(e<0||e>=t.length)return{};var n,r=s()(t[e].end.dateTime||t[e].end.date),i=s()(t[e].start.dateTime||t[e].start.date);return"offset"!==g&&"-offset"!==g||(n=Math.floor(s.a.duration(r.diff(i)).asSeconds()),"offset"===g&&(n=-n),n+="s"),[{text:n}]})}var y=t.match(/^datemath\(([^,]+), *([^,]+)\)/);if(y){var S=y[1],x=y[2],I=u.parse(S,!1);return"offset"===x||"-offset"===x?(I=Math.floor(s.a.duration(n.to.diff(I)).asSeconds()),"offset"===x&&(I=-I),I+="s"):I=I.format(x),[{text:I}]}return Promise.reject(new Error("Invalid query"))})},t.prototype.annotationQuery=function(t){var e=this,n=t.annotation,r=n.calendarId;return a.a.isEmpty(r)?this.q.when([]):this.initialize().then(function(){return(i={calendarId:r,timeMin:t.range.from.toISOString(),timeMax:t.range.to.toISOString(),orderBy:"startTime",showDeleted:!1,singleEvents:!0,maxResults:250},e.getEvents(i)).then(function(t){return a.a.chain(t).map(function(t){var e=s()(t.start.dateTime||t.start.date),r=s()(t.end.dateTime||t.end.date);return[{regionId:t.id,annotation:n,time:e.valueOf(),title:t.summary,tags:["Google Calender",t.organizer.displayName],text:t.description?t.description:""},{regionId:t.id,annotation:n,time:r.valueOf(),title:t.summary,tags:["Google Calendar",t.organizer.displayName],text:t.description?t.description:""}]}).flatten().value()});var i})},t.prototype.getEvents=function(t){var e=this;return("proxy"!==e.access?gapi.client.calendar.events.list(t):e.backendSrv.datasourceRequest({url:"/api/tsdb/query",method:"POST",data:{queries:[a.a.extend({queryType:"raw",api:"calendar.events.list",refId:"",datasourceId:e.id},t)]}})).then(function(t){return"proxy"!==e.access?t.result.items:t.data.results[""].meta.items}).catch(function(t){throw"proxy"!==e.access?t:{body:JSON.stringify({error:{message:t.data.results[""].error}})}})},t}(),m=n(5),h=(r=function(t,e){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)},function(t,e){function n(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}),g=function(t){function e(e,n){var r=t.call(this,e,n)||this;return r.scope=e,r}return e.$inject=["$scope","$injector"],h(e,t),e.prototype.onChangeInternal=function(){this.panelCtrl.refresh()},e.templateUrl="partials/query.editor.html",e}(m.QueryCtrl),v=function(){function t(t,e){this.scope=t}return t.$inject=["$scope","$injector"],t.templateUrl="partials/annotations.editor.html",t}();n.d(e,"ConfigCtrl",function(){return y}),n.d(e,"Datasource",function(){return p}),n.d(e,"QueryCtrl",function(){return g}),n.d(e,"AnnotationsQueryCtrl",function(){return v});var y=function(){function t(){}return t.templateUrl="partials/config.html",t}()}])});